#!/usr/bin/env bash
# Switch wpaperd wallpaper path based on theme mode using symlinks
# Usage: theme-wallpaper dark|light|init
#
# Since Nix makes ~/.config/wpaperd/config.toml immutable, we use a symlink
# at ~/.cache/wallpapers-current that points to the appropriate wallpaper dir.
# wpaperd config points to this symlink.

set -euo pipefail

MODE="${1:-}"
WALLPAPER_BASE="$HOME/mipnix/resources"
SYMLINK_PATH="$HOME/.cache/wallpapers-current"

if [[ -z "$MODE" ]]; then
    echo "Usage: theme-wallpaper dark|light|init" >&2
    exit 1
fi

case "$MODE" in
    dark)
        TARGET="$WALLPAPER_BASE/wallpapers-dark"
        ;;
    light)
        TARGET="$WALLPAPER_BASE/wallpapers-light"
        ;;
    init)
        # Initialize symlink based on current gsettings color-scheme
        CURRENT_SCHEME=$(gsettings get org.gnome.desktop.interface color-scheme 2>/dev/null || echo "'prefer-dark'")
        if [[ "$CURRENT_SCHEME" == *"light"* ]]; then
            TARGET="$WALLPAPER_BASE/wallpapers-light"
        else
            TARGET="$WALLPAPER_BASE/wallpapers-dark"
        fi
        ;;
    *)
        echo "Invalid mode: $MODE. Use 'dark', 'light', or 'init'." >&2
        exit 1
        ;;
esac

# Ensure cache directory exists
mkdir -p "$(dirname "$SYMLINK_PATH")"

# Update symlink (remove old one first if exists)
rm -f "$SYMLINK_PATH"
ln -s "$TARGET" "$SYMLINK_PATH"

# Reload wpaperd to apply changes
pkill -USR2 wpaperd 2>/dev/null || true
